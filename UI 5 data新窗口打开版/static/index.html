<!doctype html>
<!-- ä¸­ï¼šHTML5 æ–‡æ¡£å£°æ˜Žï¼Œå‘Šè¯‰æµè§ˆå™¨æŒ‰çŽ°ä»£æ ‡å‡†è§£æžã€‚
EN: HTML5 doctype; tells the browser to use standards mode.
FR: DÃ©claration HTML5 ; indique au navigateur dâ€™utiliser le mode standard. -->

<html lang="en">
<!--ä¸­ï¼šé¡µé¢è¯­è¨€è®¾ä¸ºè‹±æ–‡ï¼ˆå¯å½±å“è¯»å±ä¸Žæ‹¼å†™æ£€æŸ¥ï¼‰ã€‚
EN: Document language set to English (screen readers/spellcheck).
FR: Langue du document en anglais (lecteurs dâ€™Ã©cran/correction).-->


<head>
<!--ä¸­ï¼šå¤´éƒ¨å…ƒä¿¡æ¯ä¸Žæ ·å¼ã€‚
EN: Metadata and styles.
FR: MÃ©tadonnÃ©es et styles.-->
  <meta charset="utf-8"/>
  <!--ä¸­ï¼šUTF-8 ç¼–ç ï¼Œæ”¯æŒå¤šè¯­è¨€å­—ç¬¦ã€‚
  EN: UTF-8 encoding for multilingual text.
  FR: Encodage UTF-8 pour le texte multilingue.-->
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!--ä¸­ï¼šç§»åŠ¨ç«¯è‡ªé€‚åº”è§†å£ã€‚
  EN: Responsive viewport for mobile.
  FR: Viewport rÃ©actif pour mobile.-->
  <title>PV Router UI</title>
  <!--ä¸­ï¼šæµè§ˆå™¨æ ‡ç­¾æ ‡é¢˜ã€‚
  EN: Page title shown in browser tab.
  FR: Titre de lâ€™onglet du navigateur.-->
  <script src="https://cdn.tailwindcss.com"></script>
  <!--ä¸­ï¼šå¼•å…¥ TailwindCSS CDNï¼Œä¾¿æ·ä½¿ç”¨åŽŸå­ç±»æ ·å¼ã€‚
  EN: Load TailwindCSS via CDN for utility classes.
  FR: Charge TailwindCSS via CDN pour des classes utilitaires.-->
  <style>
    .navbtn{padding:.5rem 1rem;border-radius:.75rem}
    .card{border-radius:1rem;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  </style>
  <!--ä¸­ï¼šå®šä¹‰ä¸¤ä¸ªç®€å•çš„ CSS è¾…åŠ©ç±» .navbtnã€.cardã€‚
  EN: Two helper CSS classes for buttons/cards.
  FR: Deux classes CSS utilitaires pour boutons/cartes.-->
</head>


<body class="bg-gray-50 text-gray-900">
<!--ä¸­ï¼šå…¨å±€æµ…ç°èƒŒæ™¯ã€æ·±ç°æ–‡å­—ã€‚
EN: Global light-gray background, dark text.
FR: Fond gris clair, texte gris foncÃ© global.--> 
  <header class="bg-white shadow-sm sticky top-0 z-10">
  <!--ä¸­ï¼šå›ºå®šåœ¨é¡¶éƒ¨çš„ç™½è‰²å¯¼èˆªæ¡ï¼Œå«äº§å“åã€å¯¼èˆªé¡¹ã€çŠ¶æ€ä¸Žç™»å‡ºã€‚
  EN: Sticky white navbar with app name, nav items, status & logout.
  FR: Barre de navigation blanche fixe avec nom, onglets, statut & dÃ©connexion.-->
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="font-semibold">ðŸ”† PV Router</div>
      <nav class="flex gap-2 text-sm">
      <!--ä¸­ï¼šå…­ä¸ªé”šç‚¹é“¾æŽ¥ï¼Œåˆ‡æ¢ hash è·¯ç”±è‡³å„é¡µé¢ï¼ˆdashboard/history/â€¦ï¼‰
      EN: Six anchor links to hash routes for pages.
      FR: Six liens dâ€™ancrage vers les routes hash des pages.-->
      <a id="navDashboard" href="#/dashboard" class="navbtn hover:bg-gray-100">Dashboard</a>
      <a id="navData"      href="#/data"      class="navbtn hover:bg-gray-100">Data</a>
      <a id="navOptimiser" href="#/optimiser" class="navbtn hover:bg-gray-100">Optimiser</a>
      <a id="navHistory"   href="#/history"   class="navbtn hover:bg-gray-100">History</a>
      <a id="navBoost"     href="#/boost"     class="navbtn hover:bg-gray-100">Boost</a>
      <a id="navSettings"  href="#/settings"  class="navbtn hover:bg-gray-100">Settings</a>
      <a id="navMQTT"      href="#/mqtt"      class="navbtn hover:bg-gray-100">MQTT</a>
      <a id="navDev"       href="#/dev"       class="navbtn hover:bg-gray-100">Dev</a>
      <a id="navClient"    href="#/client"    class="navbtn hover:bg-gray-100">Client</a>

      </nav>
      <div class="ml-auto flex items-center gap-3 text-sm">
        <span id="statusText" class="text-gray-500"></span>
        <!--ä¸­ï¼šæ˜¾ç¤ºå½“å‰é¡µé¢åï¼ˆç”±è„šæœ¬æ›´æ–°ï¼‰ã€‚
        EN: Shows current page name (updated by JS).
        FR: Affiche la page courante (mis Ã  jour par JS).-->
        <button id="logoutBtn" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Logout</button>
        <!--ä¸­ï¼šæ¸…é™¤ä¼šè¯å¹¶è·³è½¬ç™»å½•ã€‚
        EN: Clears session and goes to login.
        FR: Efface la session et retourne Ã  la connexion.-->     
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4">
  <!--ä¸­ï¼šä¸­å¿ƒå®½åº¦é™åˆ¶ï¼Œå†…è¾¹è·å¸ƒå±€å®¹å™¨ã€‚
  EN: Centered max width container.
  FR: Conteneur centrÃ© Ã  largeur max.-->
    <!-- Login -->
    <section id="page-login" class="hidden">
      <!--ä¸­ï¼šç™»å½•è¡¨å•ï¼ˆè·¯ç”±å™¨IDã€å¯†ç ã€è¯­è¨€ï¼‰ä¸Žâ€œSign inâ€æŒ‰é’®ï¼Œé»˜è®¤éšè—ã€‚
      EN: Login form (router ID, password, language), hidden by default.
      FR: Formulaire de connexion (ID routeur, mot de passe, langue), cachÃ© par dÃ©faut.-->
      <div class="max-w-md mx-auto bg-white p-6 card">
        <h2 class="text-lg font-semibold mb-4" id="tLoginTitle">Login</h2>
        <div class="space-y-3">
          <label class="block text-sm"><span id="lblRouterId">Router ID</span>
            <input id="fRouter" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="PVROUTER001 / DEVACCOUNT"/>
            <!--ä¸­ï¼šè·¯ç”±å™¨IDæˆ–å¼€å‘è´¦å·è¾“å…¥ã€‚
            EN: Router ID or developer account input.
            FR: Saisie ID du routeur ou compte dev.-->
          </label>
          <label class="block text-sm"><span id="lblPassword">Password</span>
            <input id="fPass" type="password" class="mt-1 w-full border rounded-lg px-3 py-2"/>
            <!--ä¸­ï¼šå¯†ç è¾“å…¥ã€‚
            EN: Password input.
            FR: Saisie du mot de passe.-->
          </label>
          <label class="block text-sm"><span id="lblLanguage">Language</span>
            <select id="fLang" class="mt-1 w-full border rounded-lg px-3 py-2">
            <!--ä¸­ï¼šç•Œé¢è¯­è¨€é€‰æ‹©ï¼ˆen/frï¼‰ã€‚
            EN: UI language select.
            FR: SÃ©lecteur de langue UI.-->
              <option value="en">English</option>
              <option value="fr">FranÃ§ais</option>
            </select>
          </label>
          <button id="loginBtn" class="w-full py-2 rounded-lg bg-gray-900 text-white hover:opacity-90">Sign in</button>
          <!--ä¸­ï¼šè§¦å‘ç™»å½•è¯·æ±‚ã€‚
          EN: Triggers login request.
          FR: DÃ©clenche la connexion.-->
          <p id="loginErr" class="text-sm text-red-600"></p>
          <!--ä¸­ï¼šæ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯ã€‚
          EN: Shows login error.
          FR: Affiche lâ€™erreur de connexion.-->
        </div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="page-dashboard" class="hidden space-y-4">
    <!--ä¸­ï¼šå››å¼ å¡ç‰‡æ˜¾ç¤º Grid/Solar/TEMP1/MODEINFOï¼›ä¸‹æ–¹â€œPredictionâ€å—æ˜¾ç¤ºé¢„æµ‹ä¸Žåˆ·æ–°æ—¶é—´ã€‚
    EN: Four stat cards + â€œPredictionâ€ with refresh time.
    FR: Quatre cartes + â€œPredictionâ€ avec heure de mise Ã  jour.-->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white p-5 card"><div class="text-sm text-gray-500" id="tGridW">Grid (W)</div><div id="grid_w" class="text-3xl font-bold">--</div></div>
        <div class="bg-white p-5 card"><div class="text-sm text-gray-500" id="tSolarW">Solar (W)</div><div id="solar_w" class="text-3xl font-bold">--</div></div>
        <div class="bg-white p-5 card"><div class="text-sm text-gray-500" id="tTempC">TEMP1 (Â°C)</div><div id="temp_c" class="text-3xl font-bold">--</div></div>
        <div class="bg-white p-5 card"><div class="text-sm text-gray-500" id="tModeInfo">MODEINFO</div><div id="modeinfo" class="text-3xl font-bold">--</div></div>
       <button id="openOptimiserUiBtn" class="px-3 py-1.5 rounded-lg bg-green-600 text-white">
  Open Optimiser UI
</button>

        <!--	ä¸­ï¼šç­‰å¾…è„šæœ¬å¡«å…¥å®žæ—¶æ•°å€¼ã€‚
      EN: Placeholders pending JS fill.
      FR: Espaces rÃ©servÃ©s remplis par JS-->
      </div>

      <div class="bg-white p-5 card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold" id="tPrediction">Prediction</h3>
          <div class="flex items-center gap-3">
            <span class="text-sm text-gray-500"><span id="tUpdatedLabel">Updated:</span> <span id="updatedAt">--</span></span>
            <button id="refreshBtn" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Refresh</button>
          </div>
        </div>
        <div id="predictBox" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <div><div class="text-gray-500" id="lblNextShower">Next shower</div><div id="pred_shower" class="font-medium">--</div></div>
          <div><div class="text-gray-500" id="lblExpectedTemp">Expected temp</div><div id="pred_temp" class="font-medium">--</div></div>
          <div><div class="text-gray-500">Solar enough?</div><div id="pred_ok" class="font-medium">--</div></div>
          <div><div class="text-gray-500">Extra kWh</div><div id="pred_kwh" class="font-medium">--</div></div>
          <div><div class="text-gray-500">Est. cost</div><div id="pred_cost" class="font-medium">--</div></div>
          <div><div class="text-gray-500" id="lblSuggestedSchedule">Suggested schedule</div><div id="pred_sched" class="font-medium">--</div></div>
        </div>
      </div>

    </section>
<section id="page-optimiser" class="hidden">
  <div class="bg-white card overflow-hidden" style="height: calc(100vh - 110px);">
    <iframe id="optimiserFrame" style="width:100%;height:100%;border:0;"></iframe>
  </div>
</section>

    <!-- History -->
    <section id="page-history" class="hidden space-y-4">
      <div class="bg-white p-5 card">
        <div class="flex items-center gap-2 text-sm">
          <select id="histMetric" class="border rounded-lg px-2 py-1">
            <option value="SAVED_Cost">SAVED_Cost</option>
            <option value="TOTAL_PROD">TOTAL_PROD</option>
            <option value="INJECT">INJECT</option>
          </select>
          <select id="histRange" class="border rounded-lg px-2 py-1">
            <option value="7d">7d</option><option value="30d">30d</option>
          </select>
          <button id="histLoad" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Load</button>
          <a id="csvLink" class="ml-auto underline" href="/api/history/export.csv?range=30d">Export CSV</a>
        </div>
        <div class="mt-4">
          <pre id="histData" class="text-xs text-gray-700 whitespace-pre-wrap"></pre>
        </div>
      </div>
    </section>

    <!-- Boost -->
    <section id="page-boost" class="hidden">
      <div class="bg-white p-5 card space-y-4 max-w-xl">
        <div class="text-sm">Status: <span id="boostStatus" class="font-medium">--</span></div>
        <div class="flex gap-2">
          <button id="boostOn" class="px-3 py-1.5 rounded-lg bg-green-600 text-white hover:opacity-90">Boost ON</button>
          <button id="boostOff" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Cancel</button>
        </div>
      </div>
    </section>
<section id="page-data" class="hidden">
  <div class="bg-white card overflow-hidden" style="height: calc(100vh - 110px);">
    <iframe id="dataFrame" style="width:100%;height:100%;border:0;"></iframe>
  </div>
</section>

   <!-- Settings -->
<section id="page-settings" class="hidden">
  <div class="bg-white p-5 card space-y-3 max-w-xl">
    <h3 class="font-semibold" id="tUserSettings">User Settings</h3>

    <label class="block text-sm"><span id="lblTypicalShower">Typical shower time</span>
      <input id="s_typical" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="07:30">
    </label>

    <label class="block text-sm"><span id="lblNextShowerOverride">Next shower (override once)</span>
      <input id="s_next" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="07:30">
    </label>

    <label class="block text-sm"><span id="lblDesiredTempNext">Desired temp (next)</span>
      <input id="s_temp" type="number" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="50">
    </label>

    <label class="block text-sm"><span id="lblGuestsExpected">Guests expected</span>
      <input id="s_guests" type="number" class="mt-1 w-full border rounded-lg px-3 py-2" value="0">
    </label>

    <label class="block text-sm"><span id="lblRefreshInterval">Page refresh interval (s)</span>
      <input id="s_refresh" type="number" class="mt-1 w-full border rounded-lg px-3 py-2" value="5">
    </label>

    <div class="flex gap-2">
      <button id="s_save" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Save</button>
      <span id="s_msg" class="text-sm text-green-700"></span>
    </div>
  </div>
</section>


    <!-- MQTT -->
    <section id="page-mqtt" class="hidden">
      <div class="bg-white p-5 card space-y-2 max-w-xl text-sm">
        <div>Broker: <span id="mq_host" class="font-medium">-</span></div>
        <div>Port: <span id="mq_port" class="font-medium">-</span></div>
        <div>Connected: <span id="mq_conn" class="font-medium">-</span></div>
        <div>Last sync: <span id="mq_sync" class="font-medium">-</span></div>
        <div>Publish Hz: <span id="mq_hz" class="font-medium">-</span></div>
        <div>Sub topic: <span id="mq_topic" class="font-medium">-</span></div>
      </div>
    </section>

    <!-- Dev -->
<section id="page-dev" class="hidden">
  <div class="bg-white p-5 card space-y-5 max-w-3xl">
    <h3 class="font-semibold" id="tDevTitle">Developer</h3>

    <div class="border rounded-xl p-4 space-y-3">
      <div class="text-sm text-gray-600" id="tDevCreateHint">Create a new router account (dev only)</div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
        <label class="block"><span id="lblDevRouterId">Router ID</span>
          <input id="dev_new_id" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="PVROUTER002">
        </label>

        <label class="block"><span id="lblDevPassword">Password</span>
          <input id="dev_new_pass" type="password" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="abc123XYZ!">
        </label>

        <label class="block"><span id="lblDevRole">Role</span>
          <select id="dev_new_role" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="user" selected>user</option>
            <option value="dev">dev</option>
          </select>
        </label>

        <label class="block"><span id="lblDevRouterBase">Router base (optional)</span>
          <input id="dev_new_base" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="http://192.168.1.112">
        </label>
      </div>

      <div class="flex items-center gap-3">
        <button id="devCreateBtn" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">
          <span id="btnDevCreate">Create user</span>
        </button>
        <span id="devCreateMsg" class="text-sm"></span>
      </div>
    </div>

    <div class="space-y-3">
      <div class="text-sm text-gray-600" id="tDevListHint">List routers (dev only):</div>
      <button id="devList" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">
        <span id="btnDevLoadRouters">Load Routers</span>
      </button>
      <pre id="devOut" class="text-xs mt-2 whitespace-pre-wrap"></pre>
    </div>
  </div>
</section>


    <!-- List routers -->
    <div class="space-y-3">
      <div class="text-sm text-gray-600">List routers (dev only):</div>
      <button id="devList" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">Load Routers</button>
      <pre id="devOut" class="text-xs mt-2 whitespace-pre-wrap"></pre>
    </div>
  </div>
</section>

<!-- Client -->
<section id="page-client" class="hidden space-y-4">

  <div class="bg-white p-5 card space-y-3 max-w-2xl">
    <h3 class="font-semibold" id="tClientPosition">Client â€“ Position</h3>

    <label class="block text-sm"><span id="lblCityOptional">City (optional)</span>
      <select id="c_city" class="mt-1 w-full border rounded-lg px-3 py-2">
        <option value="" id="optCityManual">-- Manual / Other --</option>
        <option value="lille">Lille</option>
        <option value="calais">Calais</option>
        <option value="dunkerque">Dunkerque</option>
      </select>
    </label>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <label class="block text-sm"><span id="lblLatitude">Latitude</span>
        <input id="c_lat" type="number" step="0.000001" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="e.g. 50.62925">
      </label>
      <label class="block text-sm"><span id="lblLongitude">Longitude</span>
        <input id="c_lon" type="number" step="0.000001" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="e.g. 3.057256">
      </label>
      <label class="block text-sm"><span id="lblAltitudeM">Altitude (m)</span>
        <input id="c_alt" type="number" step="1" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="e.g. 25">
      </label>
    </div>
  </div>

  <div class="bg-white p-5 card space-y-3 max-w-2xl">
    <h3 class="font-semibold" id="tClientPV">Client â€“ PV parameters</h3>

    <div class="flex flex-col md:flex-row gap-4 text-sm">
      <label class="inline-flex items-center gap-2">
        <input type="radio" name="pv_mode" value="full" checked>
        <span id="lblPVFull">I know all technical details</span>
      </label>
      <label class="inline-flex items-center gap-2">
        <input type="radio" name="pv_mode" value="simple">
        <span id="lblPVSimple">I don't know all details (simple mode)</span>
      </label>
    </div>

    <div id="pv_full_box" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
      <label class="block"><span id="lblAzimuth">Azimuth du panneau</span>
        <input id="pv_azimuth_full" type="number" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="180">
      </label>
      <label class="block"><span id="lblTilt">Inclinaison / Tilt (Â°)</span>
        <input id="pv_tilt_full" type="number" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="25">
      </label>
      <label class="block"><span id="lblSurface">Surface du panneau (mÂ²)</span>
        <input id="pv_surface_full" type="number" step="0.1" class="mt-1 w-full border rounded-lg px-3 py-2">
      </label>
      <label class="block"><span id="lblPnom">Puissance nominale du panneau (Wc)</span>
        <input id="pv_pnom" type="number" class="mt-1 w-full border rounded-lg px-3 py-2">
      </label>
      <label class="block"><span id="lblInvCeiling">Plafond de puissance de lâ€™onduleur (W)</span>
        <input id="pv_inverter_ceiling" type="number" class="mt-1 w-full border rounded-lg px-3 py-2">
      </label>
      <label class="block"><span id="lblInvEff">EfficacitÃ© nominale de lâ€™onduleur</span>
        <input id="pv_inverter_eff" type="number" step="0.01" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="0.97">
      </label>
      <label class="block"><span id="lblCableLoss">Pertes dans les cÃ¢bles (%)</span>
        <input id="pv_cable_losses" type="number" step="0.1" class="mt-1 w-full border rounded-lg px-3 py-2">
      </label>
    </div>

    <div id="pv_simple_box" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm hidden">
      <label class="block"><span id="lblAzimuth2">Azimuth du panneau</span>
        <input id="pv_azimuth_simple" type="number" class="mt-1 w-full border rounded-lg px-3 py-2">
      </label>
      <label class="block"><span id="lblTilt2">Inclinaison / Tilt (Â°)</span>
        <input id="pv_tilt_simple" type="number" class="mt-1 w-full border rounded-lg px-3 py-2">
      </label>
      <label class="block"><span id="lblSurface2">Surface du panneau (mÂ²)</span>
        <input id="pv_surface_simple" type="number" step="0.1" class="mt-1 w-full border rounded-lg px-3 py-2">
      </label>
      <label class="block"><span id="lblGlobalEff">Rendement global de lâ€™installation</span>
        <input id="pv_global_eff" type="number" step="0.01" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="0.8">
      </label>

      <label class="inline-flex items-center gap-2 mt-2">
        <input id="pv_auto_adjust" type="checkbox" checked>
        <span id="lblAutoAdjust">Use auto_adjusting_params (recommended)</span>
      </label>
    </div>

    <div class="flex items-center gap-3 mt-2">
      <button id="c_save" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:opacity-90">
        <span id="btnSaveClient">Save client</span>
      </button>
      <span id="c_msg" class="text-sm text-green-700"></span>
    </div>
  </div>
</section>

  </main>

  <script>
    // ======== Session & API helper =========
document.querySelector('#openOptimiserUiBtn').onclick = ()=>{
  location.hash = '#/optimiser';
};


  
   async function apicall(path, opts={}){
  opts.headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
  opts.credentials = 'include'; // âœ… å…³é”®ï¼šè®©æµè§ˆå™¨å¸¦ä¸Š cookie

  const r = await fetch(path, opts);
  if (r.status === 401) { location.hash = '#/login'; throw new Error('Unauthorized'); }
  if (!r.ok) throw new Error(await r.text());
  const ct = r.headers.get('content-type')||'';
  return ct.includes('application/json') ? r.json() : r.text();
}

async function openOptimiserUI(){
  const j = await apicall('/api/optimiser_ui/start', {method:'POST'});
  document.getElementById('optimiserFrame').src = j.url;
}

window.addEventListener('hashchange', ()=>{
  const page = location.hash.replace('#/','');
  if (page==='optimiser') openOptimiserUI();
  // ä½ åŽŸæ¥çš„ dashboard/history/boost/settings... ä¿ç•™
});


    // ======== Router (very simple) =========
  const pages = ['login','dashboard','history','boost','settings','mqtt','dev','client','data','optimiser'];
    function show(page){
      pages.forEach(p=>document.getElementById('page-'+p).classList.add('hidden'));
      document.getElementById('page-'+page).classList.remove('hidden');
      document.getElementById('statusText').textContent = page;
    }
   let ME = null; // ç¼“å­˜å½“å‰ç”¨æˆ·ä¿¡æ¯ {router_id, role, lang}

function updateDevNavVisibility(){
  const devLink = document.getElementById('navDev');
  if (!devLink) return;
  const isDev = (ME && ME.role === 'dev');
  devLink.style.display = isDev ? '' : 'none';
}

async function ensureMe(){
  if (ME) return ME;
  // apicall å†…éƒ¨é‡åˆ° 401 ä¼šè‡ªåŠ¨è·³è½¬åˆ° #/login å¹¶ throw Error('Unauthorized')
  const j = await apicall('/api/auth/me');
  ME = j;
  // apply UI language from session (FR => full French UI)
  applyLang((j && j.lang) ? j.lang : (localStorage.getItem('ui_lang') || 'en'));
  updateDevNavVisibility();
  return ME;
}



async function guard(){
  const hash = location.hash || '#/login';
  const path = hash.replace('#/','');

  // login é¡µï¼šä¸éœ€è¦ me
  if (path === 'login'){
    ME = null;
    updateDevNavVisibility(); // é€€å‡ºæ—¶éšè— Dev
    applyLang(localStorage.getItem('ui_lang') || document.getElementById('fLang')?.value || 'en');
    show('login');
    return;
  }

  // å…¶ä»–é¡µé¢ï¼šå¿…é¡»å·²ç™»å½•
  try{
    await ensureMe();
  }catch(e){
    // apicall å·²ç»æŠŠ hash æ”¹æˆ #/login äº†ï¼Œè¿™é‡Œç›´æŽ¥ return
    return;
  }

  // éž dev ç¦æ­¢è¿›å…¥ dev é¡µ
  if (path === 'dev' && (!ME || ME.role !== 'dev')){
    location.hash = '#/dashboard';
    return;
  }

  // path ä¸åœ¨ pages åˆ—è¡¨æ—¶ï¼Œå›ž dashboard
  if (!pages.includes(path)){
    location.hash = '#/dashboard';
    return;
  }

  show(path);
if (path === 'data') openDataUI();
if (path === 'optimiser') openOptimiserUI();

}

window.addEventListener('hashchange', ()=>{ guard(); });
async function openDataUI(){
  const j = await apicall('/api/data_ui/start', {method:'POST'});
  // iframe æŒ‡å‘ streamlit
  document.getElementById('dataFrame').src = j.url;
}


    // ======== Login =========
    document.getElementById('loginBtn').onclick = async ()=>{
      const router_id = document.getElementById('fRouter').value.trim();
      const password  = document.getElementById('fPass').value;
      const lang      = document.getElementById('fLang').value;
      try{
        await apicall('/api/auth/login',{method:'POST',body:JSON.stringify({router_id,password,lang})});
        applyLang(lang);
        ME = null;               // è®© guard é‡æ–°èŽ·å– role
        location.hash = '#/dashboard';
      }
      catch(e){
        const lang = localStorage.getItem('ui_lang') || document.getElementById('fLang')?.value || 'en';
        const msg = e.message || (lang==='fr' ? 'Ã‰chec de la connexion' : 'Login failed');
        document.getElementById('loginErr').textContent = msg;
      }
    };
  document.getElementById('logoutBtn').onclick = async ()=>{
  try{ await apicall('/api/auth/logout',{method:'POST'}); }catch(e){}
  ME = null;
  updateDevNavVisibility();
  location.hash = '#/login';
};


    // ======== Dashboard =========
    async function loadStatus(){
      const j = await apicall('/api/status');
      q('#grid_w').textContent = n(j.grid_w);
      q('#solar_w').textContent = n(j.solar_w);
      q('#temp_c').textContent = n(j.temp_c);
      q('#modeinfo').textContent = j.modeinfo ?? '--';
      q('#updatedAt').textContent = new Date((j.updated_at||Date.now())*1000).toLocaleString();
      const p = j.predict || {};
      q('#pred_shower').textContent = p.next_shower ?? '--';
      q('#pred_temp').textContent = n(p.expected_temp);
      const isFR = (localStorage.getItem('ui_lang') === 'fr');
      q('#pred_ok').textContent = p.solar_enough ? (isFR ? 'OUI' : 'YES') : (isFR ? 'NON' : 'NO');

      q('#pred_kwh').textContent = n(p.extra_kwh_needed);
      q('#pred_cost').textContent = n(p.estimated_cost);
      q('#pred_sched').textContent = (p.suggested_schedule||[]).join(', ');
    }
    q('#refreshBtn').onclick = loadStatus;

    apicall('/api/optimiser_ui/start', {method:'POST'}).catch(()=>{});
    apicall('/api/data_ui/start', {method:'POST'}).catch(()=>{});


    // ======== History =========
   q('#histLoad').onclick = async ()=>{
  const m = q('#histMetric').value, r = q('#histRange').value;

  const url = `/api/history?metric=${encodeURIComponent(m)}&range=${encodeURIComponent(r)}`;
  console.log('[HISTORY] url =', url);

  const j = await apicall(url);
  q('#histData').textContent = JSON.stringify(j.series, null, 2);
  q('#csvLink').href = `/api/history/export.csv?range=${encodeURIComponent(r)}`;
};


    // ======== Boost =========
    async function refreshBoost(){
      const j = await apicall('/api/boost'); 
      const isFR = (localStorage.getItem('ui_lang') === 'fr');
    q('#boostStatus').textContent = j.active ? (isFR ? 'ACTIF' : 'ACTIVE') : (isFR ? 'INACTIF' : 'INACTIVE');

    }
    q('#boostOn').onclick  = async()=>{ await apicall('/api/boost',{method:'POST',body:JSON.stringify({on:true})});  refreshBoost(); };
    q('#boostOff').onclick = async()=>{ await apicall('/api/boost',{method:'DELETE'}); refreshBoost(); };

    // ======== Settings =========
    async function loadSettings(){
      const s = await apicall('/api/settings');
      q('#s_typical').value = s.typical_shower_time || '';
      q('#s_next').value    = s.next_shower_time || '';
      q('#s_temp').value    = s.desired_temp_next ?? 50;
      q('#s_guests').value  = s.guests_expected ?? 0;
      q('#s_refresh').value = s.page_refresh_interval ?? 5;
    }
    q('#s_save').onclick = async ()=>{
      const b = {
        typical_shower_time: q('#s_typical').value.trim(),
        next_shower_time: q('#s_next').value.trim(),
        desired_temp_next: parseFloat(q('#s_temp').value),
        guests_expected: parseInt(q('#s_guests').value||'0'),
        page_refresh_interval: parseInt(q('#s_refresh').value||'5'),
      };
      await apicall('/api/settings',{method:'POST',body:JSON.stringify(b)});
      const isFR = (localStorage.getItem('ui_lang') === 'fr');
      q('#s_msg').textContent = isFR ? 'EnregistrÃ© !' : 'Saved!';

      setTimeout(()=>q('#s_msg').textContent='', 1500);
    };

    // ======== MQTT =========
    async function loadMQTT(){
      const j = await apicall('/api/mqtt/status');
      q('#mq_host').textContent = j.broker; q('#mq_port').textContent = j.port;
      const isFR = (localStorage.getItem('ui_lang') === 'fr');
      q('#mq_conn').textContent = j.connected ? (isFR ? 'Oui' : 'Yes') : (isFR ? 'Non' : 'No');

      q('#mq_sync').textContent = j.last_sync || '-';
      q('#mq_hz').textContent   = j.publish_hz || '-';
      q('#mq_topic').textContent= j.sub_topic || '-';
    }

    // ======== Dev =========
    q('#devList').onclick = async ()=>{
      try{ const j = await apicall('/api/dev/routers'); q('#devOut').textContent = JSON.stringify(j, null, 2); }
      catch(e){ q('#devOut').textContent = e.message; }
    };
    // Create user (dev)
const devCreateBtn = document.getElementById('devCreateBtn');
if (devCreateBtn){
  devCreateBtn.onclick = async ()=>{
    const msg = document.getElementById('devCreateMsg');
    msg.textContent = '';
    msg.className = 'text-sm';

    const router_id = (document.getElementById('dev_new_id').value || '').trim();
    const password  = (document.getElementById('dev_new_pass').value || '');
    const role      = (document.getElementById('dev_new_role').value || 'user');
    const router_base = (document.getElementById('dev_new_base').value || '').trim() || null;

   if (!router_id || !password){
  msg.className = 'text-sm text-red-700';

  const isFR = (localStorage.getItem('ui_lang') === 'fr');
  msg.textContent = isFR
    ? "L'ID du routeur et le mot de passe sont requis."
    : 'Router ID and Password are required.';

  return;
}

    try{
      const payload = { router_id, password, role, router_base };
      const j = await apicall('/api/dev/create_user', { method:'POST', body: JSON.stringify(payload) });
      msg.className = 'text-sm text-green-700';
      msg.textContent = `Created: ${j.router_id}`;
      // å¯é€‰ï¼šåˆ›å»ºæˆåŠŸåŽè‡ªåŠ¨åˆ·æ–° routers åˆ—è¡¨
      try{ q('#devList').click(); }catch(e){}
    }catch(e){
      msg.className = 'text-sm text-red-700';
      msg.textContent = e.message || 'Create failed';
    }
  };
}


    // ======== Utilities =========
    function q(s){ return document.querySelector(s); }
    function n(v){ return (v===0||v) ? String(v) : '--'; }

// ======== i18n (FR full UI) =========
const I18N = {
  fr: {
    // top nav
    navDashboard: "Tableau de bord",
    navData: "DonnÃ©es",
    navOptimiser: "Optimiseur",
    navHistory: "Historique",
    navBoost: "Boost",
    navSettings: "ParamÃ¨tres",
    navMQTT: "MQTT",
    navClient: "Client",
    navDev: "Dev",

    // header / session
    logoutBtn: "Se dÃ©connecter",
    statusText: "ConnectÃ©",

    // login
    tLoginTitle: "Connexion",
    lblRouterId: "ID du routeur",
    lblPassword: "Mot de passe",
    lblLanguage: "Langue",
    loginBtn: "Se connecter",

    // dashboard
    tGridW: "RÃ©seau (W)",
    tSolarW: "Solaire (W)",
    tTempC: "TEMP1 (Â°C)",
    tModeInfo: "MODEINFO",
    tPrediction: "PrÃ©vision",
    tUpdatedLabel: "Mis Ã  jour :",
    refreshBtn: "RafraÃ®chir",
    lblNextShower: "Prochaine douche",
    lblExpectedTemp: "TempÃ©rature prÃ©vue",
    lblSuggestedSchedule: "Planning conseillÃ©",
// settings
tUserSettings: "ParamÃ¨tres utilisateur",
lblTypicalShower: "Heure habituelle de douche",
lblNextShowerOverride: "Prochaine douche (exceptionnelle)",
lblDesiredTempNext: "TempÃ©rature souhaitÃ©e (prochaine)",
lblGuestsExpected: "InvitÃ©s attendus",
lblRefreshInterval: "Intervalle de rafraÃ®chissement (s)",
s_save: "Enregistrer", // ä½ æŒ‰é’®æœ¬èº« id=s_saveï¼ˆä½†ä½ æŒ‰é’®æ–‡å­—åœ¨ HTML é‡Œæ²¡åŒ… spanï¼Œè¿™è¡Œå¯ä¸å†™ï¼›æŽ¨èæŠŠæŒ‰é’®æ–‡å­—åŒ… span æˆ–ç»™æŒ‰é’® id åšç¿»è¯‘ï¼‰

// dev
tDevTitle: "DÃ©veloppeur",
tDevCreateHint: "CrÃ©er un nouveau compte routeur (dev uniquement)",
lblDevRouterId: "ID du routeur",
lblDevPassword: "Mot de passe",
lblDevRole: "RÃ´le",
lblDevRouterBase: "Base du routeur (optionnel)",
btnDevCreate: "CrÃ©er lâ€™utilisateur",
tDevListHint: "Lister les routeurs (dev uniquement) :",
btnDevLoadRouters: "Charger les routeurs",

// client position
tClientPosition: "Client â€“ Position",
lblCityOptional: "Ville (optionnel)",
optCityManual: "-- Manuel / Autre --",
lblLatitude: "Latitude",
lblLongitude: "Longitude",
lblAltitudeM: "Altitude (m)",

// client PV
tClientPV: "Client â€“ ParamÃ¨tres PV",
lblPVFull: "Je connais tous les dÃ©tails techniques",
lblPVSimple: "Je ne connais pas tous les dÃ©tails (mode simplifiÃ©)",
lblAutoAdjust: "Utiliser auto_adjusting_params (recommandÃ©)",
btnSaveClient: "Enregistrer le client",

    // history
    histLoad: "Charger",
    csvLink: "Exporter CSV",

    // boost
    boostOn: "Activer Boost",
    boostOff: "Annuler Boost",

 
    tUserSettings: "ParamÃ¨tres utilisateur",

    tBoostStatusLabel: "Statut :",

  
    yes: "Oui",
    no: "Non",
  }
};

// ======== i18n baseline cache (restore EN mixed UI) =========
// We keep the original HTML text as "EN baseline".
// Once FR applied, switching back to EN will restore these cached strings.
const BASE_TEXT = {};
let BASE_READY = false;

function captureBaseline(){
  if (BASE_READY) return;
  const dict = I18N.fr; // only cache ids that we may translate
  for (const id of Object.keys(dict)){
    const el = document.getElementById(id);
    if (el && BASE_TEXT[id] === undefined){
      BASE_TEXT[id] = el.textContent;
    }
  }
  BASE_READY = true;
}


function applyLang(lang){
  if (!lang) return;

  // First time we touch i18n, cache the original UI text (EN baseline)
  captureBaseline();

  // Persist selection
  localStorage.setItem('ui_lang', lang);

  // If not FR => restore baseline text (your original mixed-English UI)
  if (lang !== 'fr') {
    document.documentElement.lang = lang;

    const sel = document.getElementById('fLang');
    if (sel) sel.value = lang;

    // restore original strings
    for (const [id, txt] of Object.entries(BASE_TEXT)){
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    }
    return;
  }

  // FR => overwrite with FR dict
  const dict = I18N.fr;
  for (const [id, txt] of Object.entries(dict)){
    const el = document.getElementById(id);
    if (el) el.textContent = txt;
  }

  document.documentElement.lang = 'fr';
  const sel = document.getElementById('fLang');
  if (sel) sel.value = 'fr';
}

// ======== language selector live preview =========
const langSel = document.getElementById('fLang');
if (langSel){
  langSel.addEventListener('change', (e)=>{
    applyLang(e.target.value);
  });
}


    // ======== Client page (position + PV params) =========

    // é¢„è®¾åŸŽå¸‚åæ ‡ï¼ˆç®€å•ç¤ºä¾‹å€¼ï¼‰
    const CITY_PRESETS = {
      lille:     {lat: 50.62925, lon: 3.057256, alt: 25},
      calais:    {lat: 50.95129, lon: 1.85869,  alt: 5},
      dunkerque:{lat: 51.03437, lon: 2.37682,  alt: 4},
    };

    // åŸŽå¸‚ä¸‹æ‹‰æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨å¡«å…¥ç»çº¬åº¦æµ·æ‹”
    const citySel = document.getElementById('c_city');
    if (citySel){
      citySel.onchange = ()=>{
        const v = citySel.value;
        const p = CITY_PRESETS[v];
        if (p){
          q('#c_lat').value = p.lat;
          q('#c_lon').value = p.lon;
          q('#c_alt').value = p.alt;
        }
      };
    }


    // åˆ‡æ¢ full / simple æ¨¡å¼
    function updatePVModeUI(){
      const mode = document.querySelector('input[name="pv_mode"]:checked')?.value || 'full';
      const fullBox   = document.getElementById('pv_full_box');
      const simpleBox = document.getElementById('pv_simple_box');
      if (mode === 'full'){
        fullBox.classList.remove('hidden');
        simpleBox.classList.add('hidden');
      }else{
        fullBox.classList.add('hidden');
        simpleBox.classList.remove('hidden');
      }
    }
    document.querySelectorAll('input[name="pv_mode"]').forEach(r=>{
      r.addEventListener('change', updatePVModeUI);
    });

    // è¯»å–åŽç«¯å·²æœ‰ client é…ç½®
    async function loadClient(){
      try{
        const j = await apicall('/api/client');
        if (!j || !j.position) return; // è¿˜æ²¡æœ‰ä¿å­˜è¿‡ï¼Œä¿æŒé»˜è®¤ç©ºå€¼

        // ä½ç½®
        q('#c_lat').value = j.position.latitude ?? '';
        q('#c_lon').value = j.position.longitude ?? '';
        q('#c_alt').value = j.position.altitude ?? '';

        // PV
        const pv = j.pv_config || {};
        if (pv.detail_level === 'simple'){
          document.querySelector('input[name="pv_mode"][value="simple"]').checked = true;
        }else{
          document.querySelector('input[name="pv_mode"][value="full"]').checked = true;
        }
        updatePVModeUI();

        if (pv.detail_level === 'full'){
          q('#pv_azimuth_full').value = pv.azimuth ?? '';
          q('#pv_tilt_full').value    = pv.tilt ?? '';
          q('#pv_surface_full').value = pv.surface ?? '';
          q('#pv_pnom').value         = pv.power_nominal ?? '';
          q('#pv_inverter_ceiling').value   = pv.inverter_ceiling ?? '';
          q('#pv_inverter_eff').value       = pv.inverter_efficiency ?? '';
          q('#pv_cable_losses').value       = pv.cable_losses ?? '';
        }else{
          q('#pv_azimuth_simple').value = pv.azimuth ?? '';
          q('#pv_tilt_simple').value    = pv.tilt ?? '';
          q('#pv_surface_simple').value = pv.surface ?? '';
          q('#pv_global_eff').value     = pv.global_efficiency ?? '';
          q('#pv_auto_adjust').checked  = !!pv.auto_adjusting_params;
        }
      }catch(e){
        console.error('loadClient failed', e);
      }
    }

    // ä¿å­˜ client é…ç½®åˆ°åŽç«¯
    const saveBtn = document.getElementById('c_save');
    if (saveBtn){
      saveBtn.onclick = async ()=>{
        try{
          const mode = document.querySelector('input[name="pv_mode"]:checked')?.value || 'full';
          const position = {
            latitude:  parseFloat(q('#c_lat').value),
            longitude: parseFloat(q('#c_lon').value),
            altitude:  parseFloat(q('#c_alt').value),
          };

          let pv_config;
          if (mode === 'full'){
            pv_config = {
              detail_level: 'full',
              azimuth:  parseFloat(q('#pv_azimuth_full').value),
              tilt:     parseFloat(q('#pv_tilt_full').value),
              surface:  parseFloat(q('#pv_surface_full').value),
              power_nominal:       parseFloat(q('#pv_pnom').value),
              inverter_ceiling:    parseFloat(q('#pv_inverter_ceiling').value),
              inverter_efficiency: parseFloat(q('#pv_inverter_eff').value),
              cable_losses:        parseFloat(q('#pv_cable_losses').value),
              global_efficiency: null,
              auto_adjusting_params: null
            };
          }else{
            pv_config = {
              detail_level: 'simple',
              azimuth:  parseFloat(q('#pv_azimuth_simple').value),
              tilt:     parseFloat(q('#pv_tilt_simple').value),
              surface:  parseFloat(q('#pv_surface_simple').value),
              power_nominal: null,
              inverter_ceiling: null,
              inverter_efficiency: null,
              cable_losses: null,
              global_efficiency: parseFloat(q('#pv_global_eff').value),
              auto_adjusting_params: !!q('#pv_auto_adjust').checked
            };
          }

          await apicall('/api/client', {
            method:'POST',
            body: JSON.stringify({position, pv_config})
          });
          const isFR = (localStorage.getItem('ui_lang') === 'fr');
          q('#c_msg').textContent = isFR ? 'EnregistrÃ© !' : 'Saved!';

          setTimeout(()=>q('#c_msg').textContent='', 1500);
        }catch(e){
          q('#c_msg').textContent = 'Error: ' + (e.message || 'save failed');
        }
      };
    }

    applyLang(localStorage.getItem('ui_lang') || 'en');

    // åˆå§‹è·¯ç”±
    guard();
    // é¦–æ¬¡è¿›å…¥å„é¡µæ—¶åšè½»é‡åŠ è½½
    window.addEventListener('hashchange', ()=>{
      const page = location.hash.replace('#/','');
      if (page==='dashboard') loadStatus();
      if (page==='history')   q('#histLoad').click();
      if (page==='boost')     refreshBoost();
      if (page==='settings')  loadSettings();
      if (page==='mqtt')      loadMQTT();
      if (page==='client')    loadClient();
    });
  </script>
</body>
</html>
